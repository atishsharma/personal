<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cordyceps Lab Design Editor</title>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-canvas: #1e293b;
            --bg-sidebar: #1e293b;
            --grid-color: #334155;
            --accent: #ff00ff;
            --text-primary: var(--accent);
            --text-secondary: #94a3b8;
            --rack-stroke: #64748b;
            --rack-fill: rgba(100, 116, 139, 0.1);
            --fan-color: #ef4444;
            --wall-stroke: #cbd5e1;
            --humidifier-color: #3b82f6;
            --block-rack: #2563eb;
            --block-prep: #facc15;
            --block-clean: #4a044e;
            --dimension-line: #ff00ff;
            --imprint-line: rgba(255, 0, 255, 0.4);
            --text-block-bg: #ff00ff;
            --text-block-color: #000000;
            --blackout-red: #ef4444;
            --prep-yellow: #facc15;
        }

        body.light-theme {
            --bg-body: #f1f5f9;
            --bg-canvas: #ffffff;
            --bg-sidebar: #ffffff;
            --grid-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --sidebar-border: #e2e8f0;
            --wall-stroke: #1e293b;
            --rack-fill: rgba(241, 245, 249, 0.8);
            --imprint-line: rgba(0, 0, 0, 0.3);
            --dimension-line: #000;
            --text-block-bg: #e2e8f0;
            --text-block-color: #000000;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s ease;
            touch-action: manipulation;
        }

        .header {
            width: 95%;
            max-width: 1200px;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--accent);
        }

        .app-container {
            display: flex;
            width: 95%;
            max-width: 1200px;
            gap: 20px;
            padding-bottom: 20px;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                width: 95% !important;
                max-height: 35vh !important;
            }

            .canvas-wrapper {
                transform: scale(0.8);
                margin: -40px 0;
            }
        }

        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border: 1px solid var(--grid-color);
            border-radius: 12px;
            padding: 15px;
            height: fit-content;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .inventory-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .inventory-item {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid var(--text-secondary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            touch-action: none;
        }

        .inventory-item:hover {
            border-color: var(--accent);
            background: rgba(255, 0, 255, 0.05);
            color: var(--accent);
        }

        .item-color-preview {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .canvas-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-wrapper {
            background-color: var(--bg-canvas);
            border-radius: 4px;
            width: 740px;
            height: 380px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        svg#labDesigner {
            width: 740px;
            height: 380px;
            overflow: visible;
            background: var(--bg-canvas);
        }

        /* Component Classes */
        .placed-element {
            cursor: move;
            pointer-events: all;
        }

        .placed-element:hover .ui-controls,
        .active-element .ui-controls {
            opacity: 1;
        }

        .ui-controls {
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: all;
        }

        .btn-del {
            fill: #ef4444;
            cursor: pointer;
        }

        .btn-rot {
            fill: var(--accent);
            cursor: pointer;
        }

        .btn-resize {
            fill: #facc15;
            cursor: nwse-resize;
        }

        .btn-edit {
            fill: #3b82f6;
            cursor: pointer;
        }

        .rack {
            fill: var(--rack-fill);
            stroke: var(--rack-stroke);
            stroke-width: 1.5;
        }

        .rack.blackout {
            stroke: var(--blackout-red);
            stroke-width: 2.5;
        }

        .label-text {
            font-size: 7px;
            text-transform: uppercase;
            font-weight: 800;
            pointer-events: none;
            text-anchor: middle;
            fill: white;
        }

        .name-block {
            rx: 3;
            ry: 3;
        }

        .imprint-line {
            stroke: var(--imprint-line);
            stroke-width: 0.75;
            stroke-dasharray: 1, 2;
        }

        .imprint-text {
            font-size: 6px;
            fill: var(--imprint-line);
            font-weight: 600;
        }

        .imprint-del {
            fill: #ef4444;
            cursor: pointer;
            opacity: 0.4;
        }

        .specs-panel {
            width: 100%;
            background: rgba(0, 0, 0, 0.02);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            box-sizing: border-box;
        }

        .spec-item strong {
            color: var(--accent);
            display: block;
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        .spec-value {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .btn-action {
            padding: 8px 12px;
            background: #334155;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-undo {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-undo:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Modal UI */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: var(--bg-sidebar);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            width: 350px;
            box-shadow: 0 0 30px var(--accent);
        }

        .modal-content h2 {
            font-size: 0.9rem;
            color: var(--accent);
            margin: 0 0 15px 0;
        }

        .modal-input {
            width: 100%;
            height: 100px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--text-secondary);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            margin-bottom: 20px;
            box-sizing: border-box;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .svg-text-wrap {
            color: var(--text-block-color);
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px;
            box-sizing: border-box;
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            word-break: break-word;
            pointer-events: none;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 0;
            }

            html,
            body {
                height: 100% !important;
                overflow: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                background-color: white !important;
            }

            body {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 10mm !important;
                box-sizing: border-box !important;
            }

            .sidebar,
            .controls,
            .ui-controls,
            .imprint-del,
            #main-footer,
            .modal-overlay {
                display: none !important;
            }

            .app-container {
                display: flex !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                justify-content: center !important;
            }

            .header {
                padding: 0 0 5mm 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 740px !important;
            }

            .canvas-wrapper {
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                width: 740px !important;
                height: 380px !important;
                padding: 0 !important;
            }

            .specs-panel {
                max-width: 740px !important;
                width: 740px !important;
                margin: 5mm 0 0 0 !important;
                padding: 10px !important;
                background: none !important;
                border: 1px solid #000 !important;
            }

            .print-footer {
                display: block !important;
                text-align: right !important;
                width: 740px !important;
                margin: 3mm 0 0 0 !important;
                font-weight: 800 !important;
                color: black !important;
                font-size: 11pt !important;
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            * {
                page-break-inside: avoid !important;
            }
        }

        .print-footer {
            display: none;
        }
    </style>
</head>

<body class="light-theme">

    <div class="header">
        <div>
            <h1>Cordyceps Lab Design</h1>
            <p style="font-size: 0.8rem; opacity: 0.7;">Architectural Floor Plan (2 Inch Grid)</p>
        </div>
        <div class="controls">
            <button onclick="exportLayout()" class="btn-action">Export JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-action">Import JSON</button>
            <input type="file" id="importFile" style="display:none" accept="application/json"
                onchange="importLayout(event)">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.65rem; font-weight: 800; text-transform: uppercase;">Theme</span>
                <label class="switch"><input type="checkbox" id="themeToggle" checked><span
                        class="slider"></span></label>
            </div>
            <button onclick="window.print()" class="btn-action" style="background: #334155;">Export PDF</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <h3 style="font-size: 0.8rem; margin-top: 0; color: var(--accent); letter-spacing: 0.1em;">LIBRARY</h3>
            <div id="inventory" class="inventory-list"></div>
            <button id="undoBtn" class="btn-undo" disabled>Undo Last Action</button>
        </aside>
        <main class="canvas-area">
            <div class="canvas-wrapper">
                <svg id="labDesigner" viewBox="0 0 740 380">
                    <defs>
                        <pattern id="grid" width="5" height="5" patternUnits="userSpaceOnUse">
                            <path d="M 5 0 L 0 0 0 5" fill="none" stroke="var(--grid-color)" stroke-width="0.2" />
                        </pattern>
                        <pattern id="grid-major" width="30" height="30" patternUnits="userSpaceOnUse">
                            <path d="M 30 0 L 0 0 0 30" fill="none" stroke="var(--grid-color)" stroke-width="0.8" />
                        </pattern>
                    </defs>
                    <g id="structural-dims">
                        <line x1="40" y1="20" x2="700" y2="20" stroke="var(--accent)" stroke-width="1"
                            stroke-dasharray="2,2" />
                        <text x="370" y="15" class="label-text" style="fill: var(--accent); font-size: 10px;">22.0 ft
                            Internal</text>
                        <line x1="20" y1="40" x2="20" y2="340" stroke="var(--accent)" stroke-width="1"
                            stroke-dasharray="2,2" />
                        <text x="15" y="190" class="label-text" style="fill: var(--accent); font-size: 10px;"
                            transform="rotate(-90 15 190)">10.0 ft Internal</text>
                    </g>
                    <rect x="40" y="40" width="660" height="300" fill="url(#grid)" />
                    <rect x="40" y="40" width="660" height="300" fill="url(#grid-major)" />
                    <rect x="40" y="40" width="660" height="300" class="wall"
                        style="stroke: var(--wall-stroke); stroke-width: 8; fill: none;" />
                    <g id="fixed-layer">
                        <g transform="translate(140, 40)">
                            <rect x="0" y="-4" width="90" height="8" fill="rgba(0,0,0,0.05)" />
                            <path d="M 0 0 Q 45 45 90 0" fill="none" stroke="var(--accent)" stroke-dasharray="4" />
                            <rect x="5" y="-14" width="80" height="14" fill="rgba(239, 68, 68, 0.2)"
                                stroke="var(--fan-color)" stroke-width="2" />
                            <text x="45" y="-20" class="label-text"
                                style="fill: var(--fan-color); font-size: 8px;">Airtight Fan</text>
                        </g>
                        <g transform="translate(700, 130)">
                            <rect x="0" y="0" width="8" height="125" fill="var(--ac-color)" />
                            <text x="25" y="62" class="label-text" style="fill: var(--ac-color); font-size: 8px;"
                                transform="rotate(90 25 62)">Wall HVAC</text>
                        </g>
                    </g>
                    <g id="imprint-layer"></g>
                    <g id="interactive-layer" transform="translate(40, 40)"></g>
                </svg>
            </div>
            <div class="specs-panel" id="specs"></div>
            <div class="print-footer">Property of Atish Ak Sharma</div>
        </main>
    </div>

    <div id="textModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Edit Element Name</h2>
            <textarea id="modalInput" class="modal-input" placeholder="Enter custom name..."></textarea>
            <div class="modal-btns">
                <button onclick="closeModal()" class="btn-action" style="background:#475569">Cancel</button>
                <button onclick="saveModalText()" class="btn-action">Save Changes</button>
            </div>
        </div>
    </div>

    <footer id="main-footer"
        style="padding: 10px 0 20px; font-size: 0.7rem; opacity: 0.5; font-weight: 800; letter-spacing: 0.2em;">PROPERTY
        OF ATISH AK SHARMA</footer>

    <script>
        const svg = document.getElementById('labDesigner'), interactiveLayer = document.getElementById('interactive-layer');
        const imprintLayer = document.getElementById('imprint-layer'), inventoryEl = document.getElementById('inventory');
        const specsEl = document.getElementById('specs'), themeToggle = document.getElementById('themeToggle'), undoBtn = document.getElementById('undoBtn');
        const textModal = document.getElementById('textModal'), modalInput = document.getElementById('modalInput');

        const GRID = 30, SNAP = 5, OFFSET_X = 40, OFFSET_Y = 40, CANVAS_W = 660, CANVAS_H = 300;
        let placedItems = [], history = [], hiddenImprints = new Set(), activeAction = null, currentItem = null, startAngle = 0, startRotation = 0, editingItemUid = null;

        const library = [
            { id: 'rack_std', label: 'Std Rack', w: 2, h: 1, type: 'rack', blockColor: '#2563eb' },
            { id: 'rack_blk', label: 'Blackout Rack', w: 2, h: 1, type: 'rack', isBlackout: true, blockColor: '#2563eb' },
            { id: 'prep', label: 'Prep Station', w: 4, h: 2.5, type: 'prep', blockColor: '#facc15' },
            { id: 'flow', label: 'Flow Hood', w: 2, h: 4, type: 'equip', blockColor: '#a855f7' },
            { id: 'fridge', label: 'Fridge', w: 2, h: 2, type: 'equip', blockColor: '#4c1d95' },
            { id: 'dehy', label: 'Dehydrator', w: 2, h: 3, type: 'equip', blockColor: '#701a75' },
            { id: 'sink', label: 'Sink', w: 2, h: 2, type: 'equip', blockColor: '#1e40af' },
            { id: 'auto', label: 'Autoclave', w: 1.5, h: 1.5, type: 'equip', blockColor: '#581c87' },
            { id: 'humid', label: 'Humidifier', w: 1.5, h: 1.5, type: 'humid', blockColor: '#3b82f6' },
            { id: 'text', label: 'Text Block', w: 3, h: 1, type: 'text', isResizable: true, blockColor: '#ff00ff' }
        ];

        function pushHistory() {
            history.push(JSON.stringify({ items: placedItems, hidden: Array.from(hiddenImprints) }));
            if (history.length > 50) history.shift();
            undoBtn.disabled = false;
        }

        function undo() {
            if (history.length === 0) return;
            const state = JSON.parse(history.pop());
            placedItems = state.items; hiddenImprints = new Set(state.hidden);
            if (history.length === 0) undoBtn.disabled = true;
            render();
        }

        undoBtn.addEventListener('click', undo);

        function initInventory() {
            library.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.innerHTML = `<span>${item.label}</span><div style="display:flex;align-items:center;gap:8px;"><span style="opacity:0.6">${item.w}'x${item.h}'</span><div class="item-color-preview" style="background:${item.blockColor || 'transparent'};"></div></div>`;
                div.onclick = () => { pushHistory(); addItem(item); };
                inventoryEl.appendChild(div);
            });
        }

        function addItem(def) {
            const uid = 'uid-' + Math.random().toString(36).substr(2, 9);
            const item = { ...def, uid, x: 150, y: 120, rot: 0, cw: def.w, ch: def.h, customTitle: '' };
            placedItems.push(item); render();
        }

        function removeItem(uid) { pushHistory(); placedItems = placedItems.filter(i => i.uid !== uid); render(); }
        function toggleImprint(id) { pushHistory(); if (hiddenImprints.has(id)) hiddenImprints.delete(id); else hiddenImprints.add(id); render(); }

        function render() {
            interactiveLayer.innerHTML = ''; let rackCount = 0;
            placedItems.forEach(item => {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "placed-element");
                const width = (item.cw || item.w) * GRID, height = (item.ch || item.h) * GRID, cx = width / 2, cy = height / 2;
                g.setAttribute("transform", `translate(${item.x},${item.y}) rotate(${item.rot},${cx},${cy})`);

                const displayTitle = item.customTitle || (item.type === 'rack' ? `R${++rackCount}` : (item.type === 'text' ? 'NOTE' : item.label));
                if (item.type === 'rack') {
                    if (!item.customTitle) rackCount--; // Re-increment inside actual loop
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    r.setAttribute("width", width); r.setAttribute("height", height);
                    r.setAttribute("class", `rack ${item.isBlackout ? 'blackout' : ''}`);
                    g.appendChild(r);
                    const finalRackLabel = item.customTitle || `R${++rackCount}`;
                    addLabel(g, cx, cy, finalRackLabel, 'var(--block-rack)', true);
                } else if (item.type === 'prep') {
                    const r1 = document.createElementNS("http://www.w3.org/2000/svg", "rect"); r1.setAttribute("width", width); r1.setAttribute("height", height);
                    r1.setAttribute("fill", "none"); r1.setAttribute("stroke", "var(--prep-yellow)"); r1.setAttribute("stroke-width", "4");
                    const r2 = r1.cloneNode(); r2.setAttribute("stroke-width", "1.5"); g.appendChild(r1); g.appendChild(r2);
                    addLabel(g, cx, cy, displayTitle, 'var(--prep-yellow)', false);
                } else if (item.type === 'equip') {
                    const r1 = document.createElementNS("http://www.w3.org/2000/svg", "rect"); r1.setAttribute("width", width); r1.setAttribute("height", height);
                    r1.setAttribute("fill", "none"); r1.setAttribute("stroke", item.blockColor); r1.setAttribute("stroke-width", "4");
                    const r2 = r1.cloneNode(); r2.setAttribute("stroke-width", "1.5"); g.appendChild(r1); g.appendChild(r2);
                    addLabel(g, cx, cy, displayTitle, item.blockColor, false);
                } else if (item.type === 'humid') {
                    const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon"); poly.setAttribute("points", `0,${height} ${width / 2},0 ${width},${height}`);
                    poly.setAttribute("fill", "none"); poly.setAttribute("stroke", "var(--humidifier-color)"); poly.setAttribute("stroke-width", "4");
                    const poly2 = poly.cloneNode(); poly2.setAttribute("stroke-width", "1.5"); g.appendChild(poly); g.appendChild(poly2);
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text"); t.setAttribute("x", width / 2); t.setAttribute("y", height + 15);
                    t.setAttribute("class", "label-text"); t.setAttribute("style", "fill: var(--humidifier-color); font-size: 8px; font-weight:800;");
                    t.textContent = displayTitle; g.appendChild(t);
                } else if (item.type === 'text') {
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect"); r.setAttribute("width", width); r.setAttribute("height", height);
                    r.setAttribute("fill", "var(--text-block-bg)"); r.setAttribute("stroke", "var(--accent)"); r.setAttribute("stroke-width", "1");
                    g.appendChild(r);
                    const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                    fo.setAttribute("width", width); fo.setAttribute("height", height);
                    const div = document.createElement("div"); div.className = "svg-text-wrap"; div.textContent = displayTitle;
                    fo.appendChild(div); g.appendChild(fo);
                }

                // UI Controls
                const ui = document.createElementNS("http://www.w3.org/2000/svg", "g"); ui.setAttribute("class", "ui-controls");
                ui.appendChild(createControl(0, 0, 15, "btn-del", "×", (e) => removeItem(item.uid)));
                ui.appendChild(createControl(width, 0, 15, "btn-rot", "⟳", (e) => startAction(e, item, 'rotate')));
                ui.appendChild(createControl(0, height, 15, "btn-edit", "✎", (e) => openEditModal(item)));
                if (item.isResizable) ui.appendChild(createControl(width, height, 15, "btn-resize", "↘", (e) => startAction(e, item, 'resize')));

                g.appendChild(ui);
                g.onmousedown = (e) => { if (e.target.tagName !== 'circle') startAction(e, item, 'drag'); };
                g.addEventListener('touchstart', (e) => { if (e.target.tagName !== 'circle') startAction(e, item, 'drag'); }, { passive: false });
                interactiveLayer.appendChild(g);
            });
            updateSpecs(); renderImprints();
        }

        function createControl(x, y, r, cls, char, callback) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", x); c.setAttribute("cy", y); c.setAttribute("r", r); c.setAttribute("class", cls);
            c.addEventListener('mousedown', (e) => { e.stopPropagation(); callback(e); });
            c.addEventListener('touchstart', (e) => { e.stopPropagation(); e.preventDefault(); callback(e); }, { passive: false });
            const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", x); t.setAttribute("y", y + (char === '×' ? 6 : 4));
            t.setAttribute("style", `fill:white; font-size:${char === '×' ? '18' : '12'}px; font-weight:bold; text-anchor:middle; pointer-events:none;`);
            t.textContent = char; g.appendChild(c); g.appendChild(t); return g;
        }

        function addLabel(parent, x, y, text, color, isSmall) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", x); t.setAttribute("y", y + 3); t.setAttribute("class", "label-text");
            if (isSmall) t.style.fontSize = "6px"; t.textContent = text;
            const w = isSmall ? 22 : text.length * 6 + 10, h = isSmall ? 10 : 14;
            const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            r.setAttribute("x", x - w / 2); r.setAttribute("y", y - h / 2 + 1); r.setAttribute("width", w); r.setAttribute("height", h);
            r.setAttribute("class", "name-block"); r.setAttribute("fill", color);
            g.appendChild(r); g.appendChild(t); parent.appendChild(g);
        }

        function openEditModal(item) {
            editingItemUid = item.uid;
            modalInput.value = item.customTitle || (item.type === 'rack' ? '' : item.label);
            textModal.style.display = 'flex'; modalInput.focus();
        }
        function closeModal() { textModal.style.display = 'none'; editingItemUid = null; }
        function saveModalText() { if (editingItemUid) { pushHistory(); const item = placedItems.find(i => i.uid === editingItemUid); if (item) item.customTitle = modalInput.value.toUpperCase(); render(); } closeModal(); }

        function getCoords(e) {
            const CTM = svg.getScreenCTM();
            let cX = e.touches ? e.touches[0].clientX : e.clientX, cY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (cX - CTM.e) / CTM.a, y: (cY - CTM.f) / CTM.d };
        }

        function startAction(e, item, type) {
            if (e.cancelable) e.preventDefault(); pushHistory(); activeAction = type; currentItem = item; const pt = getCoords(e);
            if (type === 'drag') { item.ox = pt.x - item.x - OFFSET_X; item.oy = pt.y - item.y - OFFSET_Y; }
            else if (type === 'rotate') {
                const cx = item.x + OFFSET_X + ((item.cw || item.w) * GRID / 2);
                const cy = item.y + OFFSET_Y + ((item.ch || item.h) * GRID / 2);
                startAngle = Math.atan2(pt.y - cy, pt.x - cx); startRotation = item.rot;
            }
            const moveH = (m) => handleMove(m), endH = () => { window.removeEventListener('mousemove', moveH); window.removeEventListener('touchmove', moveH); window.removeEventListener('mouseup', endH); window.removeEventListener('touchend', endH); activeAction = null; currentItem = null; render(); };
            window.addEventListener('mousemove', moveH); window.addEventListener('touchmove', moveH, { passive: false }); window.addEventListener('mouseup', endH); window.addEventListener('touchend', endH);
        }

        function handleMove(e) {
            if (!currentItem) return; if (e.cancelable) e.preventDefault(); const pt = getCoords(e);
            if (activeAction === 'drag') {
                let nx = Math.round((pt.x - currentItem.ox - OFFSET_X) / SNAP) * SNAP, ny = Math.round((pt.y - currentItem.oy - OFFSET_Y) / SNAP) * SNAP;
                currentItem.x = Math.max(0, Math.min(nx, CANVAS_W - (currentItem.cw || currentItem.w) * GRID));
                currentItem.y = Math.max(0, Math.min(ny, CANVAS_H - (currentItem.ch || currentItem.h) * GRID));
            } else if (activeAction === 'rotate') {
                const cx = currentItem.x + OFFSET_X + ((currentItem.cw || currentItem.w) * GRID / 2);
                const cy = currentItem.y + OFFSET_Y + ((currentItem.ch || currentItem.h) * GRID / 2);
                const angle = Math.atan2(pt.y - cy, pt.x - cx);
                currentItem.rot = Math.round((startRotation + (angle - startAngle) * 180 / Math.PI));
            } else if (activeAction === 'resize') {
                currentItem.cw = Math.max(0.5, (pt.x - currentItem.x - OFFSET_X) / GRID); currentItem.ch = Math.max(0.5, (pt.y - currentItem.y - OFFSET_Y) / GRID);
            }
            render();
        }

        function renderImprints() {
            imprintLayer.innerHTML = '';
            placedItems.forEach(item => {
                const w = (item.cw || item.w) * GRID, h = (item.ch || item.h) * GRID, ix = item.x + OFFSET_X, iy = item.y + OFFSET_Y;
                let close = { t: OFFSET_Y, b: OFFSET_Y + CANVAS_H, l: OFFSET_X, r: OFFSET_X + CANVAS_W };
                placedItems.forEach(o => {
                    if (o.uid === item.uid) return;
                    const ow = (o.cw || o.w) * GRID, oh = (o.ch || o.h) * GRID, ox = o.x + OFFSET_X, oy = o.y + OFFSET_Y;
                    if (ix < ox + ow && ix + w > ox) { if (oy + oh <= iy && oy + oh > close.t) close.t = oy + oh; if (oy >= iy + h && oy < close.b) close.b = oy; }
                    if (iy < oy + oh && iy + h > oy) { if (ox + ow <= ix && ox + ow > close.l) close.l = ox + ow; if (ox >= ix + w && ox < close.r) close.r = ox; }
                });
                [{ d: (iy - close.t) / GRID, p: [ix + w / 2, close.t, ix + w / 2, iy], id: 't' }, { d: (close.b - (iy + h)) / GRID, p: [ix + w / 2, iy + h, ix + w / 2, close.b], id: 'b' }, { d: (ix - close.l) / GRID, p: [close.l, iy + h / 2, ix, iy + h / 2], id: 'l' }, { d: (close.r - (ix + w)) / GRID, p: [ix + w, iy + h / 2, close.r, iy + h / 2], id: 'r' }].forEach(dir => {
                    if (dir.d > 0.1 && !hiddenImprints.has(`${item.uid}-${dir.id}`)) {
                        const g = document.createElementNS("http://www.w3.org/2000/svg", "g"), l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        l.setAttribute("x1", dir.p[0]); l.setAttribute("y1", dir.p[1]); l.setAttribute("x2", dir.p[2]); l.setAttribute("y2", dir.p[3]); l.setAttribute("class", "imprint-line");
                        const mx = (dir.p[0] + dir.p[2]) / 2, my = (dir.p[1] + dir.p[3]) / 2;
                        const t = document.createElementNS("http://www.w3.org/2000/svg", "text"); t.setAttribute("x", mx + 3); t.setAttribute("y", my + 2); t.setAttribute("class", "imprint-text"); t.textContent = `${dir.d.toFixed(1)}'`;
                        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx", mx - 4); c.setAttribute("cy", my - 1); c.setAttribute("r", 7); c.setAttribute("class", "imprint-del");
                        c.onclick = () => toggleImprint(`${item.uid}-${dir.id}`);
                        c.addEventListener('touchstart', (e) => { e.stopPropagation(); toggleImprint(`${item.uid}-${dir.id}`); });
                        const tx = document.createElementNS("http://www.w3.org/2000/svg", "text"); tx.setAttribute("x", mx - 4); tx.setAttribute("y", my + 1); tx.setAttribute("style", "fill:white; font-size:6px; font-weight:bold; text-anchor:middle; pointer-events:none;"); tx.textContent = "×";
                        g.appendChild(l); g.appendChild(t); g.appendChild(c); g.appendChild(tx); imprintLayer.appendChild(g);
                    }
                });
            });
        }

        function updateSpecs() {
            const counts = {}; placedItems.forEach(i => counts[i.label] = (counts[i.label] || 0) + 1);
            specsEl.innerHTML = `
                <div class="spec-item"><strong>GROW AREA</strong><span class="spec-value">Std Racks: ${counts['Std Rack'] || 0} (2x1')<br>Blackout: ${counts['Blackout Rack'] || 0} (2x1')</span></div>
                <div class="spec-item"><strong>PROCESSING</strong><span class="spec-value">Prep Station: ${counts['Prep Station'] || 0} (4x2.5')<br>Flow Hood: ${counts['Flow Hood'] || 0} (2x4')<br>Fridge/Sink: ${(counts['Fridge'] || 0) + (counts['Sink'] || 0)} (2x2')</span></div>
                <div class="spec-item"><strong>UTILITIES</strong><span class="spec-value">Humidifier: ${counts['Humidifier'] || 0}<br>Auto: ${counts['Autoclave'] || 0}</span></div>
            `;
        }

        function exportLayout() {
            const blob = new Blob([JSON.stringify({ items: placedItems, hidden: Array.from(hiddenImprints) })], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cordyceps_lab.json'; a.click();
        }

        function importLayout(e) {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader(); r.onload = (ev) => {
                try { const d = JSON.parse(ev.target.result); pushHistory(); placedItems = d.items; hiddenImprints = new Set(d.hidden); render(); } catch (err) { alert('Invalid file'); }
            }; r.readAsText(f);
        }

        themeToggle.onchange = () => { document.body.classList.toggle('light-theme', themeToggle.checked); render(); };
        window.onload = () => { initInventory(); render(); };
    </script>
</body>

</html>